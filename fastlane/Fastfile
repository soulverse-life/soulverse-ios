# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do

  desc "Push a dev build to Testflight"
  lane :development do |option|
    # Set up API key first
    api_key = app_store_connect_api_key(
      key_id: ENV["API_KEY_ID"],
      issuer_id: ENV["API_ISSUER_ID"],
      key_filepath: ENV["API_KEY_FILEPATH"]
    )

    version_num = get_version_number(xcodeproj: "Soulverse.xcodeproj", target: ENV["SCHEME"])

    # Fetch latest build number from TestFlight for the current version
    begin
      latest_build = latest_testflight_build_number(
        api_key: api_key,
        version: version_num,
        app_identifier: ENV["BUNDLE_IDENTIFIER"]
      )
      build_num = latest_build + 1
      UI.message("ðŸ“¦ Latest TestFlight build: #{latest_build}, using build number: #{build_num}")
    rescue => ex
      UI.important("âš ï¸  Could not fetch latest build number from TestFlight: #{ex.message}")
      UI.important("Using fallback: incrementing local build number")
      increment_build_number(xcodeproj: "Soulverse.xcodeproj", skip_info_plist: true)
      build_num = get_build_number(xcodeproj: "Soulverse.xcodeproj")
    end

    increment_build_number(
      build_number: build_num,
      xcodeproj: "Soulverse.xcodeproj",
      skip_info_plist: true
    )
    build_app(
      workspace: "Soulverse.xcworkspace",
      scheme: ENV["SCHEME"],
      configuration: "Debug",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          ENV["BUNDLE_IDENTIFIER"] => "match AppStore #{ENV["BUNDLE_IDENTIFIER"]}"
        }
      }
    )
    upload_to_testflight(
      skip_submission: true,
      api_key: api_key
    )
  end

  desc "Push a release build to Testflight"
  lane :release do |option|
    # Set up API key first
    api_key = app_store_connect_api_key(
      key_id: ENV["API_KEY_ID"],
      issuer_id: ENV["API_ISSUER_ID"],
      key_filepath: ENV["API_KEY_FILEPATH"]
    )

    version_num = get_version_number(xcodeproj: "Soulverse.xcodeproj", target: ENV["SCHEME"])

    # Fetch latest build number from TestFlight for the current version
    begin
      latest_build = latest_testflight_build_number(
        api_key: api_key,
        version: version_num,
        app_identifier: ENV["BUNDLE_IDENTIFIER"]
      )
      build_num = latest_build + 1
      UI.message("ðŸ“¦ Latest TestFlight build: #{latest_build}, using build number: #{build_num}")
    rescue => ex
      UI.important("âš ï¸  Could not fetch latest build number from TestFlight: #{ex.message}")
      UI.important("Using fallback: incrementing local build number")
      increment_build_number(xcodeproj: "Soulverse.xcodeproj", skip_info_plist: true)
      build_num = get_build_number(xcodeproj: "Soulverse.xcodeproj")
    end

    increment_build_number(
      build_number: build_num,
      xcodeproj: "Soulverse.xcodeproj",
      skip_info_plist: true
    )

    # Disable automatic code signing and set provisioning profile
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "Soulverse.xcodeproj",
      team_id: "387UQ56LV7",
      code_sign_identity: "Apple Distribution",
      bundle_identifier: ENV["BUNDLE_IDENTIFIER"],
      profile_name: "match AppStore " + ENV["BUNDLE_IDENTIFIER"]
    )

    build_app(
      workspace: "Soulverse.xcworkspace",
      scheme: ENV["SCHEME"],
      configuration: "Release",
      export_method: "app-store",
      include_bitcode: false,
      codesigning_identity: "Apple Distribution",
      export_options: {
        compileBitcode: false,
        stripSwiftSymbols: false,
        embedOnDemandResourcesAssetPacksInBundle: true,
        method: "app-store",
        provisioningProfiles: {
          ENV["BUNDLE_IDENTIFIER"] => "match AppStore " + ENV["BUNDLE_IDENTIFIER"]
        }
      }
    )
    upload_to_testflight(
      skip_submission: true,
      api_key: api_key,
      distribute_external: false,
      groups: ["dev"]
    )
  end

  desc "Test upload existing IPA to TestFlight"
  lane :test_upload do
    api_key = app_store_connect_api_key(
      key_id: ENV["API_KEY_ID"],
      issuer_id: ENV["API_ISSUER_ID"],
      key_filepath: ENV["API_KEY_FILEPATH"]
    )
    upload_to_testflight(
      skip_submission: true,
      ipa: "/Users/mingshing/Soulverse/Soulverse.ipa",
      api_key: api_key
    )
  end

  desc "Test Match provisioning profile download"
  lane :test_match do
    # Sync provisioning profiles
    match(
      type: "appstore",
      readonly: true,
      verbose: true
    )

    # List downloaded profiles
    sh("ls -la ~/Library/MobileDevice/Provisioning\\ Profiles/ || echo 'No profiles directory'")

    # Show profile details
    sh("security find-identity -v -p codesigning")

    UI.success("âœ… Match sync completed successfully!")
    UI.message("Check the output above to verify profiles were downloaded")
  end
end
