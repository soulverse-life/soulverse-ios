# Backend Service Design: Mood Check-In, Drawings & Journals

**Date:** 2026-02-21
**Status:** Approved
**Approach:** Firestore + Firebase Storage (Hybrid D — Cloud Functions added later)

---

## Overview

Design the backend data layer for storing mood check-in records, drawings (with recording data), and journals. All data is user-scoped and accessed via Firebase client SDKs directly from the iOS app.

### Architecture Decision

**Firestore + Firebase Storage** for Phase 1. Cloud Functions will be added later for:
- Milestone notifications (e.g., 10th check-in congratulation)
- Thumbnail generation for drawings
- Server-side aggregation if needed

### Why This Approach

- Firebase already configured (`soulverse-35106`) with Auth, Firestore, Storage
- All queries are user-scoped — Firestore handles this natively
- Zero infrastructure to deploy or maintain
- Built-in offline persistence and real-time sync
- Progressive: can add Cloud Functions without changing iOS code

---

## Data Models

### Firestore: `users/{uid}/mood_checkins/{checkinId}`

| Field | Type | Required | Description |
|---|---|---|---|
| colorHex | string | Yes | Hex color from Sensing step, e.g., "#FFD700" |
| colorIntensity | double | Yes | 0.0 - 1.0, from Sensing step |
| emotion | string | Yes | RecordedEmotion uniqueKey, e.g., "joy", "love" |
| topic | string | Yes | Topic rawValue, e.g., "emotional", "physical" |
| evaluation | string | Yes | EvaluationOption rawValue |
| journal | string | No | Optional free-form journal text (replaces old promptResponse) |
| createdAt | timestamp | Yes | UTC server timestamp |
| updatedAt | timestamp | Yes | UTC server timestamp |
| timezoneOffsetMinutes | int | Yes | User's timezone at check-in time, e.g., 480 for UTC+8 |

**Note:** The Shaping step (prompt selection + promptResponse) is removed from the check-in flow. Replaced by the optional journal field.

### Firestore: `users/{uid}/drawings/{drawingId}`

| Field | Type | Required | Description |
|---|---|---|---|
| checkinId | string | No | Links to mood_checkins doc; null if standalone drawing |
| isFromCheckIn | bool | Yes | true = created during check-in flow |
| imageURL | string | Yes | Firebase Storage URL for rendered PNG |
| recordingURL | string | Yes | Firebase Storage URL for PKDrawing binary data |
| thumbnailURL | string | No | Populated later by Cloud Functions |
| promptUsed | string | No | Canvas prompt text if one was shown |
| createdAt | timestamp | Yes | UTC server timestamp |
| updatedAt | timestamp | Yes | UTC server timestamp |
| timezoneOffsetMinutes | int | Yes | User's timezone at drawing time |

### Firebase Storage Structure

```
users/{uid}/drawings/{drawingId}/image.png        # Rendered drawing (required)
users/{uid}/drawings/{drawingId}/recording.pkd     # PKDrawing binary data (required)
users/{uid}/drawings/{drawingId}/thumbnail.png     # Future: generated by Cloud Functions
```

---

## MoodEntriesSection Card Assembly Logic

### Card Types

| Scenario | Card Type | Content |
|---|---|---|
| Check-in + drawings | Normal card | Emotion, journal, color, up to 3 drawings |
| Check-in only | Normal card | Emotion, journal, color, no drawings |
| Drawings only (no check-in that day) | Orphan card | No emotion/journal, just drawings |

### Drawing-to-Card Association Rules

1. Drawings with `checkinId != null` → attach to that check-in's card
2. Standalone drawings (`checkinId == null`) between two check-ins → attach to the preceding check-in's card
3. Standalone drawings on a day with no check-in → orphan card for that day
4. Multiple check-ins per day → multiple cards for that day

### Query Strategy

```
Step 1: Query latest X check-ins
  → mood_checkins, order by createdAt DESC, limit X

Step 2: Derive date range from results
  → startOfDay(oldestCheckin.createdAt) to now

Step 3: Query all drawings in that date range
  → drawings, where createdAt >= startOfDay, order by createdAt DESC

Step 4: Client-side assembly
  → Group by day (using device timezone)
  → Attach drawings to check-ins
  → Create orphan cards for drawing-only days
  → Limit to 3 images per card for display
```

---

## Query Patterns

### Home Screen — Recent Filter (latest 7 check-ins)

```
mood_checkins
  .order(by: "createdAt", descending: true)
  .limit(to: 7)
```

### MoodEntriesSection — Cards

See Card Assembly Logic above. Two sequential queries.

### Insight — Weekly Mood Score Chart

```
mood_checkins
  .whereField("createdAt", isGreaterThan: weekStart)
  .whereField("createdAt", isLessThan: weekEnd)
  .order(by: "createdAt")
```

Client applies emotion → score mapping formula. Multiple check-ins per day = multiple points on same x-axis.

### InnerCosmo — Daily Emotion Planets

```
mood_checkins
  .whereField("createdAt", isGreaterThan: todayStart)
  .order(by: "createdAt")
```

---

## Firestore Indexes

| Collection | Fields | Type |
|---|---|---|
| mood_checkins | createdAt DESC | Automatic (single-field) |
| drawings | createdAt DESC | Automatic (single-field) |
| drawings | checkinId + createdAt | Composite (needs explicit creation) |

---

## Timezone Handling

- All Firestore timestamps are stored as UTC
- `timezoneOffsetMinutes` field records the user's local timezone at write time
- Client-side grouping by day uses device timezone (`Calendar.current`)
- Server-side grouping (future Cloud Functions) can use the stored offset

---

## Security Rules

### Firestore

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;

      match /mood_checkins/{checkinId} {
        allow read, delete: if request.auth.uid == uid;
        allow create: if request.auth.uid == uid
                      && request.resource.data.keys().hasAll([
                           'colorHex', 'colorIntensity', 'emotion',
                           'topic', 'evaluation', 'createdAt'
                         ]);
        allow update: if request.auth.uid == uid;
      }

      match /drawings/{drawingId} {
        allow read, delete: if request.auth.uid == uid;
        allow create: if request.auth.uid == uid
                      && request.resource.data.keys().hasAll([
                           'imageURL', 'recordingURL', 'isFromCheckIn', 'createdAt'
                         ]);
        allow update: if request.auth.uid == uid;
      }
    }
  }
}
```

### Firebase Storage

```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /users/{uid}/drawings/{drawingId}/{fileName} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if request.auth != null && request.auth.uid == uid
                   && request.resource.size < 10 * 1024 * 1024
                   && (fileName.matches('image\\.png')
                       || fileName.matches('recording\\.pkd')
                       || fileName.matches('thumbnail\\.png'));
      allow delete: if request.auth != null && request.auth.uid == uid;
    }
  }
}
```

---

## Future: Cloud Functions (Phase 2)

When added, Cloud Functions will handle:

1. **Milestone notifications** — Firestore trigger on `mood_checkins` create, count total, send FCM if milestone reached
2. **Thumbnail generation** — Storage trigger on image upload, generate resized image, update `thumbnailURL` field
3. **Weekly summary notifications** — Scheduled function, aggregate check-in counts, send FCM
4. **Data validation** — Server-side validation before writes

No iOS code changes needed — functions attach to existing collections via triggers.

---

## Check-in Flow Changes

The mood check-in flow is updated:

| Step | Status | Data |
|---|---|---|
| Sensing | Kept | colorHex, colorIntensity |
| Naming | Kept | emotion (RecordedEmotion) |
| Shaping | **Removed** | ~~promptOption, promptResponse~~ |
| Attributing | Kept | topic |
| Evaluating | Kept | evaluation |
| Acting | Kept | Optional drawing |
| Journal | **New** | Optional free-form text |
